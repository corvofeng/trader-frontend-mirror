// Full updated code provided above